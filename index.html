<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>2x4 MIDI Pad (C4) — Optimized</title>
<style>
  :root{--bg:#071022;--panel:#0b1220;--accent:#60a5fa;--muted:#9ca3af}
  html,body{height:100%;margin:0;background:var(--bg);color:#e6eef8;font-family:Inter,system-ui,Segoe UI,Roboto,Arial}
  .container{display:flex;align-items:flex-start;justify-content:center;height:100%;padding:28px;box-sizing:border-box}
  .pad-grid{display:grid;grid-template-columns:repeat(2,140px);grid-template-rows:repeat(4,100px);gap:14px;touch-action:manipulation;-webkit-tap-highlight-color:transparent}
  .pad{background:#081827;border-radius:10px;display:flex;flex-direction:column;align-items:center;justify-content:center;user-select:none;cursor:pointer;-webkit-user-select:none;transition:transform .06s;box-shadow:0 6px 18px rgba(2,6,23,.6)}
  .pad:active,.pad.active{transform:translateY(2px);box-shadow:0 3px 8px rgba(2,6,23,.5)}
  .pad .note{font-weight:700;font-size:18px}
  .pad .midi{font-size:12px;color:var(--muted);margin-top:6px}
  .controls{display:flex;flex-direction:column;gap:10px;margin-left:28px;min-width:220px}
  select,input[type=range],button{background:transparent;border:1px solid rgba(255,255,255,0.04);padding:8px;border-radius:8px;color:var(--accent)}
  label{font-size:13px;color:var(--muted)}
  .hint{font-size:12px;color:var(--muted)}
  button{background:var(--accent);color:#042033;border:none}
</style>
</head>
<body>
  <div class="container">
    <div class="pad-grid" id="padGrid"></div>

    <div class="controls" id="controls">
      <label class="hint">Octave shift (semitones: ±12)</label>
      <input id="octave" type="range" min="-2" max="2" value="0" step="1">
      <div class="hint">Current shift: <span id="octVal">0</span></div>

      <label class="hint">Velocity</label>
      <input id="velocity" type="range" min="1" max="127" value="100">
      <div class="hint">Velocity: <span id="velVal">100</span></div>

      <label class="hint">MIDI Output</label>
      <select id="midiOutput"></select>

      <button id="allOff">All Notes Off</button>
      <div class="hint">Tip: use loopMIDI to create/select a virtual port. Touchscreens: use touchstart for near-zero latency.</div>
    </div>
  </div>

<script>
/* ==========================
   Optimized 2x4 MIDI Pad
   - preallocated messages
   - cached DOM refs
   - touchstart with passive:false + preventDefault
   - typed arrays
   - minimal hot-path work
   ==========================*/

// --- constants & helpers ---
const NOTE_NAMES = ['C','C#','D','D#','E','F','F#','G','G#','A','A#','B'];
const BASE_START = 60; // C4
const PAD_COUNT = 8;

function noteName(n){ return NOTE_NAMES[n % 12] + (Math.floor(n/12)-1); }

// --- cached DOM elements ---
const padGrid = document.getElementById('padGrid');
const octaveEl = document.getElementById('octave');
const octVal = document.getElementById('octVal');
const velocityEl = document.getElementById('velocity');
const velVal = document.getElementById('velVal');
const midiSelect = document.getElementById('midiOutput');
const allOffBtn = document.getElementById('allOff');

// --- MIDI state (cached for direct access) ---
let midiAccess = null;
let selectedOutput = null;
let octaveShift = 0; // in octaves (±2)

// Preallocated message buffers for each pad (we'll update note byte on octave change)
const padOnMsgs = new Array(PAD_COUNT);
const padOffMsgs = new Array(PAD_COUNT);

// Hold references to pad elements for instant access
const padEls = new Array(PAD_COUNT);

// --- build pads (runs once) ---
(function buildPads(){
  for(let i=0;i<PAD_COUNT;i++){
    const el = document.createElement('div');
    el.className = 'pad';
    const midi = BASE_START + i; // initial
    el.innerHTML = `<div class="note">${noteName(midi)}</div><div class="midi">MIDI ${midi}</div>`;
    padGrid.appendChild(el);
    padEls[i] = el;
    // create typed arrays filled with placeholder note; we'll set note byte later
    padOnMsgs[i] = new Uint8Array([0x90, midi & 0x7f, Number(velocityEl.value) & 0x7f]);
    padOffMsgs[i] = new Uint8Array([0x80, midi & 0x7f, 0x00]);

    // HOT-PATH: minimal inline handlers. Use touchstart (passive:false) + click fallback
    el.addEventListener('touchstart', (e)=>{ e.preventDefault(); el.classList.add('active'); selectedOutput && selectedOutput.send(padOnMsgs[i]); }, {passive:false});
    el.addEventListener('touchend',   (e)=>{ e.preventDefault(); el.classList.remove('active'); selectedOutput && selectedOutput.send(padOffMsgs[i]); }, {passive:false});
    // mouse
    el.addEventListener('mousedown',  ()=>{ el.classList.add('active'); selectedOutput && selectedOutput.send(padOnMsgs[i]); });
    el.addEventListener('mouseup',    ()=>{ el.classList.remove('active'); selectedOutput && selectedOutput.send(padOffMsgs[i]); });
    el.addEventListener('mouseleave', ()=>{ el.classList.remove('active'); selectedOutput && selectedOutput.send(padOffMsgs[i]); });
  }
})();

// --- update messages when octave or velocity changes ---
function updatePadMessages(){
  const vel = Number(velocityEl.value) & 0x7f;
  const shift = Number(octaveEl.value) * 12; // semitone shift
  octaveShift = Number(octaveEl.value);
  octVal.textContent = octaveShift;
  velVal.textContent = vel;

  for(let i=0;i<PAD_COUNT;i++){
    const midi = (BASE_START + i + shift) & 0x7f;
    // update DOM note label fast (direct child nodes)
    const el = padEls[i];
    const noteDiv = el.firstElementChild; // .note
    const midiDiv = noteDiv.nextElementSibling; // .midi
    noteDiv.textContent = noteName(midi);
    midiDiv.textContent = 'MIDI ' + midi;

    // reuse typed arrays, only update the note byte
    padOnMsgs[i][1] = midi;
    padOnMsgs[i][2] = vel;
    padOffMsgs[i][1] = midi;
  }
}

// --- MIDI init & populate (cached operations) ---
async function initMIDI(){
  if(!navigator.requestMIDIAccess){ return; }
  try{
    midiAccess = await navigator.requestMIDIAccess({sysex:false});
    midiAccess.onstatechange = populateOutputs; // refresh when devices change
    populateOutputs();
  }catch(e){ /* ignore */ }
}

function populateOutputs(){
  // minimal DOM work in one shot
  midiSelect.innerHTML = '';
  const outs = Array.from(midiAccess.outputs.values());
  for(const o of outs){
    const opt = document.createElement('option'); opt.value = o.id; opt.textContent = o.name || (o.manufacturer || 'MIDI Output'); midiSelect.appendChild(opt);
  }
  // auto-select first
  if(outs.length) { selectedOutput = outs[0]; midiSelect.value = selectedOutput.id; }
}

midiSelect.addEventListener('change', ()=>{ selectedOutput = midiAccess.outputs.get(midiSelect.value); });

// All Notes Off (send to all outputs quickly)
allOffBtn.addEventListener('click', ()=>{
  if(!midiAccess) return;
  midiAccess.outputs.forEach(o=>{ try{ o.send([0xB0,0x7B,0x00]); }catch(e){} });
  padEls.forEach(p=>p.classList.remove('active'));
});

// update on controls
octaveEl.addEventListener('input', ()=>{ updatePadMessages(); });
velocityEl.addEventListener('input', ()=>{ updatePadMessages(); });

// initial update
updatePadMessages();
initMIDI();

</script>
</body>
</html>
